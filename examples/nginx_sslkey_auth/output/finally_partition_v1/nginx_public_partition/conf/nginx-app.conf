worker_processes 1;
daemon off;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    
    # 日志
    access_log  logs/public_access.log;
    error_log   logs/public_error.log info;
    
    sendfile        on;
    keepalive_timeout  65;
    
    # 应用服务器 - 接收来自 sslkey 域的明文流量
    server {
        listen 127.0.0.1:8080;  # 只监听本地回环，不对外暴露
        server_name localhost;
        
        # 公共内容（无需认证）
        location /public {
            alias html/public;
            index index.html;
        }
        
        location /public/ {
            alias html/public/;
            index index.html;
        }
        
        # API 接口（无需认证）
        location /api {
            alias html/api;
            index index.html;
        }
        
        location /api/ {
            alias html/api/;
            index index.html;
        }
        
        # 管理页面（需要认证）- 这里会触发 RPC 调用
        location /admin {
            auth_basic "Restricted Area - Admin Access";
            auth_basic_user_file ../auth/.htpasswd;
            
            alias html/admin;
            index index.html;
        }
        
        location /admin/ {
            auth_basic "Restricted Area - Admin Access";
            auth_basic_user_file ../auth/.htpasswd;
            
            alias html/admin/;
            index index.html;
        }
        
        # 根路径
        location = / {
            return 200 "Welcome! Available paths: /public, /api, /admin\n";
            add_header Content-Type text/plain;
        }
        
        # 健康检查
        location /public-health {
            access_log off;
            return 200 "App Server OK\n";
            add_header Content-Type text/plain;
        }
    }
}
