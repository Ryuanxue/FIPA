# ğŸ›ï¸ Nginxå¤šåŸŸé€šä¿¡é…ç½®æ–‡ä»¶
# nginx-multi-domain.conf

# ==================================================
# åŸŸå®šä¹‰ (Domain Definitions)
# ==================================================

domains {
    # ğŸ”§ é…ç½®è§£æåŸŸ - ä¸­å¤®åè°ƒå™¨
    configuration {
        process_name    "nginx-config-parser";
        listen_port     50051;
        security_level  HIGH;
        max_connections 100;
        
        # ğŸ§½ å¤„ç†çš„æ±¡æŸ“æºç±»å‹
        taint_sources {
            config_directives;      # é…ç½®æŒ‡ä»¤
            config_parameters;      # é…ç½®å‚æ•°
            ssl_certificate_paths;  # SSLè¯ä¹¦è·¯å¾„
            ssl_private_key_paths;  # SSLç§é’¥è·¯å¾„ ğŸ”‘
            include_files;          # åŒ…å«æ–‡ä»¶è·¯å¾„
        }
        
        # ğŸ¯ æä¾›çš„æœåŠ¡
        services {
            CONFIG_PARSE;           # è§£æé…ç½®æ–‡ä»¶
            CONFIG_VALIDATE;        # éªŒè¯é…ç½®
            CONFIG_DISTRIBUTE;      # åˆ†å‘é…ç½®åˆ°å…¶ä»–åŸŸ
        }
    }
    
    # ğŸ” SSLè¯ä¹¦ç®¡ç†åŸŸ - æœ€é«˜å®‰å…¨çº§åˆ«
    ssl_certificate {
        process_name    "nginx-ssl-manager";
        listen_port     50052;
        security_level  CRITICAL;
        max_connections 50;
        
        # ğŸ§½ å¤„ç†çš„æ±¡æŸ“æºç±»å‹
        taint_sources {
            ssl_private_key_paths;  # SSLç§é’¥æ–‡ä»¶è·¯å¾„ ğŸ”‘
            ssl_certificate_paths;  # SSLè¯ä¹¦æ–‡ä»¶è·¯å¾„
            ssl_configurations;     # SSLé…ç½®å‚æ•°
            key_passphrases;        # ç§é’¥å¯†ç  (å¦‚æœæœ‰)
        }
        
        # ğŸ¯ æä¾›çš„æœåŠ¡
        services {
            SSL_LOAD_CERTIFICATE;   # åŠ è½½SSLè¯ä¹¦
            SSL_LOAD_PRIVATE_KEY;   # åŠ è½½SSLç§é’¥ ğŸ”‘
            SSL_VERIFY_KEY_PAIR;    # éªŒè¯è¯ä¹¦å¯†é’¥å¯¹
            SSL_CREATE_CONTEXT;     # åˆ›å»ºSSLä¸Šä¸‹æ–‡
            SSL_GET_STATUS;         # è·å–SSLçŠ¶æ€
        }
        
        # ğŸ”’ ç‰¹æ®Šå®‰å…¨è®¾ç½®
        security_options {
            encrypt_rpc_messages    on;     # åŠ å¯†RPCæ¶ˆæ¯
            require_auth_token      on;     # éœ€è¦è®¤è¯token
            log_all_access          on;     # è®°å½•æ‰€æœ‰è®¿é—®
            restrict_file_access    on;     # é™åˆ¶æ–‡ä»¶è®¿é—®
        }
    }
    
    # ğŸŒ HTTPå¤„ç†åŸŸ - å¤„ç†ç½‘ç»œè¯·æ±‚
    http_processing {
        process_name    "nginx-http-handler";
        listen_port     50053;
        security_level  MEDIUM;
        max_connections 1000;
        
        # ğŸ§½ å¤„ç†çš„æ±¡æŸ“æºç±»å‹
        taint_sources {
            http_request_headers;   # HTTPè¯·æ±‚å¤´
            http_request_body;      # HTTPè¯·æ±‚ä½“
            url_parameters;         # URLå‚æ•°
            cookies;                # Cookieæ•°æ®
            user_agents;            # User-Agentå­—ç¬¦ä¸²
        }
        
        # ğŸ¯ æä¾›çš„æœåŠ¡
        services {
            HTTP_PROCESS_REQUEST;   # å¤„ç†HTTPè¯·æ±‚
            HTTP_ROUTE_REQUEST;     # è·¯ç”±è¯·æ±‚
            HTTP_GENERATE_RESPONSE; # ç”Ÿæˆå“åº”
            HTTP_HANDLE_KEEPALIVE;  # å¤„ç†Keep-Alive
        }
    }
    
    # ğŸ” è®¤è¯æˆæƒåŸŸ - å¤„ç†ç”¨æˆ·èº«ä»½éªŒè¯
    authentication {
        process_name    "nginx-auth-service";
        listen_port     50054;
        security_level  HIGH;
        max_connections 200;
        
        # ğŸ§½ å¤„ç†çš„æ±¡æŸ“æºç±»å‹
        taint_sources {
            user_credentials;       # ç”¨æˆ·å‡­æ®
            auth_tokens;           # è®¤è¯token
            session_ids;           # ä¼šè¯ID
            basic_auth_headers;    # Basicè®¤è¯å¤´
            bearer_tokens;         # Bearer token
        }
        
        # ğŸ¯ æä¾›çš„æœåŠ¡
        services {
            AUTH_AUTHENTICATE_USER; # ç”¨æˆ·è®¤è¯
            AUTH_VALIDATE_TOKEN;    # tokenéªŒè¯
            AUTH_CHECK_PERMISSIONS; # æƒé™æ£€æŸ¥
            AUTH_CREATE_SESSION;    # åˆ›å»ºä¼šè¯
            AUTH_LOGOUT_USER;       # ç”¨æˆ·ç™»å‡º
        }
    }
    
    # ğŸ“ æ–‡ä»¶ç³»ç»ŸåŸŸ - å¤„ç†æ–‡ä»¶è®¿é—®
    file_system {
        process_name    "nginx-file-manager";
        listen_port     50055;
        security_level  MEDIUM;
        max_connections 500;
        
        # ğŸ§½ å¤„ç†çš„æ±¡æŸ“æºç±»å‹
        taint_sources {
            file_paths;            # æ–‡ä»¶è·¯å¾„
            directory_paths;       # ç›®å½•è·¯å¾„
            file_content;          # æ–‡ä»¶å†…å®¹
            file_permissions;      # æ–‡ä»¶æƒé™
        }
        
        # ğŸ¯ æä¾›çš„æœåŠ¡
        services {
            FILE_READ;             # è¯»å–æ–‡ä»¶
            FILE_WRITE;            # å†™å…¥æ–‡ä»¶
            FILE_CHECK_PERMISSIONS; # æ£€æŸ¥æ–‡ä»¶æƒé™
            FILE_LIST_DIRECTORY;   # åˆ—å‡ºç›®å½•
            FILE_GET_STATUS;       # è·å–æ–‡ä»¶çŠ¶æ€
        }
    }
}

# ==================================================
# è·¨åŸŸé€šä¿¡è§„åˆ™ (Cross-Domain Communication Rules)
# ==================================================

cross_domain_access {
    
    # ğŸ”§ ConfigurationåŸŸè®¿é—®è§„åˆ™
    rule "config_to_ssl" {
        source_domain       configuration;
        target_domain       ssl_certificate;
        allowed_operations  SSL_LOAD_CERTIFICATE, SSL_LOAD_PRIVATE_KEY, SSL_VERIFY_KEY_PAIR;
        required_auth_level HIGH;
        
        # ğŸ”‘ SSLç§é’¥è·¯å¾„ä¼ é€’è§„åˆ™
        taint_propagation_rules {
            allow_taint_type    ssl_private_key_paths;
            require_encryption  on;
            audit_trail        on;
            max_path_length    256;
        }
    }
    
    rule "config_to_auth" {
        source_domain       configuration;
        target_domain       authentication;
        allowed_operations  AUTH_CREATE_SESSION;  # ä»…å…è®¸åˆ›å»ºç®¡ç†å‘˜ä¼šè¯
        required_auth_level HIGH;
    }
    
    rule "config_to_http" {
        source_domain       configuration;
        target_domain       http_processing;
        allowed_operations  HTTP_ROUTE_REQUEST;   # ä»…å…è®¸è®¾ç½®è·¯ç”±
        required_auth_level HIGH;
    }
    
    rule "config_to_file" {
        source_domain       configuration;
        target_domain       file_system;
        allowed_operations  FILE_READ, FILE_CHECK_PERMISSIONS;
        required_auth_level HIGH;
    }
    
    # ğŸŒ HTTPå¤„ç†åŸŸè®¿é—®è§„åˆ™
    rule "http_to_ssl" {
        source_domain       http_processing;
        target_domain       ssl_certificate;
        allowed_operations  SSL_GET_STATUS;      # ä»…æŸ¥è¯¢ï¼Œä¸èƒ½ä¿®æ”¹
        required_auth_level MEDIUM;
    }
    
    rule "http_to_auth" {
        source_domain       http_processing;
        target_domain       authentication;
        allowed_operations  AUTH_AUTHENTICATE_USER, AUTH_VALIDATE_TOKEN, AUTH_CHECK_PERMISSIONS;
        required_auth_level MEDIUM;
        
        # ç”¨æˆ·å‡­æ®ä¼ é€’è§„åˆ™
        taint_propagation_rules {
            allow_taint_type    user_credentials, auth_tokens;
            require_encryption  on;
            audit_trail        on;
            session_timeout    300;  # 5åˆ†é’Ÿ
        }
    }
    
    rule "http_to_file" {
        source_domain       http_processing;
        target_domain       file_system;
        allowed_operations  FILE_READ, FILE_CHECK_PERMISSIONS;
        required_auth_level MEDIUM;
        
        # æ–‡ä»¶è·¯å¾„ä¼ é€’è§„åˆ™
        taint_propagation_rules {
            allow_taint_type    file_paths;
            path_restrictions   "/var/www/html/*", "/usr/share/nginx/html/*";
            deny_paths         "/etc/*", "/proc/*", "/sys/*";
        }
    }
    
    # ğŸ” SSLåŸŸè®¿é—®è§„åˆ™
    rule "ssl_to_file" {
        source_domain       ssl_certificate;
        target_domain       file_system;
        allowed_operations  FILE_READ, FILE_CHECK_PERMISSIONS;
        required_auth_level CRITICAL;
        
        # ğŸ”‘ SSLæ–‡ä»¶è®¿é—®è§„åˆ™
        taint_propagation_rules {
            allow_taint_type    ssl_private_key_paths, ssl_certificate_paths;
            path_restrictions   "/etc/nginx/ssl/*", "/etc/ssl/*";
            require_encryption  on;
            audit_trail        on;
        }
    }
    
    # ğŸ” è®¤è¯åŸŸè®¿é—®è§„åˆ™
    rule "auth_to_file" {
        source_domain       authentication;
        target_domain       file_system;
        allowed_operations  FILE_READ;           # è¯»å–ç”¨æˆ·æ•°æ®åº“
        required_auth_level HIGH;
        
        taint_propagation_rules {
            allow_taint_type    file_paths;
            path_restrictions   "/etc/nginx/auth/*";
        }
    }
    
    # ğŸš« æ˜ç¡®ç¦æ­¢çš„è·¨åŸŸè®¿é—®
    deny_rules {
        # HTTPåŸŸä¸èƒ½ç›´æ¥ä¿®æ”¹é…ç½®
        deny "http_processing -> configuration" for "CONFIG_*";
        
        # è®¤è¯åŸŸä¸èƒ½è®¿é—®SSLç§é’¥
        deny "authentication -> ssl_certificate" for "SSL_LOAD_PRIVATE_KEY";
        
        # æ–‡ä»¶ç³»ç»ŸåŸŸä¸èƒ½ä¸»åŠ¨è®¿é—®å…¶ä»–åŸŸ
        deny "file_system -> *" for "*";
        
        # SSLåŸŸä¸èƒ½ä¿®æ”¹é…ç½®
        deny "ssl_certificate -> configuration" for "CONFIG_*";
    }
}

# ==================================================
# å®‰å…¨ç­–ç•¥ (Security Policies)
# ==================================================

security_policies {
    
    # ğŸ” è®¤è¯ç­–ç•¥
    authentication_policy {
        require_mutual_auth     on;              # éœ€è¦åŒå‘è®¤è¯
        token_lifetime          300;             # tokenæœ‰æ•ˆæœŸ5åˆ†é’Ÿ
        max_auth_failures       3;               # æœ€å¤§è®¤è¯å¤±è´¥æ¬¡æ•°
        lockout_duration        60;              # é”å®šæ—¶é—´1åˆ†é’Ÿ
        
        # ğŸ”‘ é’ˆå¯¹SSLç§é’¥è·¯å¾„çš„ç‰¹æ®Šè®¤è¯
        ssl_private_key_access {
            require_admin_token     on;          # éœ€è¦ç®¡ç†å‘˜token
            audit_all_access        on;          # å®¡è®¡æ‰€æœ‰è®¿é—®
            encrypt_in_transit      on;          # ä¼ è¾“åŠ å¯†
            encrypt_at_rest         on;          # å­˜å‚¨åŠ å¯†
        }
    }
    
    # ğŸ§½ æ±¡æŸ“æºç®¡ç†ç­–ç•¥
    taint_management_policy {
        default_taint_level     MEDIUM;
        
        # é«˜é£é™©æ±¡æŸ“æº
        high_risk_sources {
            ssl_private_key_paths   CRITICAL;
            user_credentials        HIGH;
            auth_tokens            HIGH;
            key_passphrases        CRITICAL;
        }
        
        # è·¨åŸŸä¼ æ’­é™åˆ¶
        cross_domain_limits {
            max_domains_per_taint   2;           # æ¯ä¸ªæ±¡æŸ“æ•°æ®æœ€å¤šè·¨è¶Š2ä¸ªåŸŸ
            require_sanitization    on;          # éœ€è¦æ•°æ®æ¸…æ´—
            log_all_propagation     on;          # è®°å½•æ‰€æœ‰ä¼ æ’­
        }
    }
    
    # ğŸ“Š ç›‘æ§å’Œå®¡è®¡ç­–ç•¥
    monitoring_policy {
        log_level               INFO;
        audit_critical_ops      on;             # å®¡è®¡å…³é”®æ“ä½œ
        performance_monitoring  on;             # æ€§èƒ½ç›‘æ§
        
        # ğŸ”‘ SSLç§é’¥è·¯å¾„ç‰¹æ®Šç›‘æ§
        ssl_key_monitoring {
            log_all_access          on;
            alert_on_unusual        on;
            track_access_patterns   on;
        }
        
        alerts {
            failed_auth_threshold       5;       # è®¤è¯å¤±è´¥å‘Šè­¦é˜ˆå€¼
            high_error_rate_threshold   10;      # é«˜é”™è¯¯ç‡å‘Šè­¦
            unusual_access_pattern      on;      # å¼‚å¸¸è®¿é—®æ¨¡å¼å‘Šè­¦
        }
    }
    
    # ğŸ›¡ï¸ æ•…éšœå¤„ç†ç­–ç•¥
    failure_handling {
        circuit_breaker_enabled     on;         # å¯ç”¨ç†”æ–­å™¨
        circuit_breaker_threshold   10;         # ç†”æ–­é˜ˆå€¼
        circuit_breaker_timeout     30;         # ç†”æ–­è¶…æ—¶æ—¶é—´
        
        failover_policy {
            enable_backup_domains       on;     # å¯ç”¨å¤‡ä»½åŸŸ
            automatic_failover          on;     # è‡ªåŠ¨æ•…éšœè½¬ç§»
            health_check_interval       10;     # å¥åº·æ£€æŸ¥é—´éš”(ç§’)
        }
        
        # ğŸ”‘ SSLåŸŸç‰¹æ®Šæ•…éšœå¤„ç†
        ssl_domain_failure {
            emergency_ssl_context       "/etc/nginx/emergency.pem";
            fallback_to_http            off;    # ä¸å›é€€åˆ°HTTP
            notify_admin               on;      # é€šçŸ¥ç®¡ç†å‘˜
        }
    }
}

# ==================================================
# æ€§èƒ½ä¼˜åŒ–é…ç½® (Performance Optimization)
# ==================================================

performance_config {
    
    # è¿æ¥æ± é…ç½®
    connection_pools {
        enable_pooling              on;
        pool_size_per_domain        20;
        connection_timeout          30;
        idle_timeout               300;
        max_lifetime               3600;
    }
    
    # æ¶ˆæ¯æ‰¹å¤„ç†
    message_batching {
        enable_batching             on;
        batch_size                 10;
        batch_timeout              100;    # æ¯«ç§’
        compress_large_messages     on;
    }
    
    # ç¼“å­˜ç­–ç•¥
    caching {
        enable_response_cache       on;
        cache_ttl                  60;     # ç¼“å­˜TTL(ç§’)
        cache_size_limit           100MB;
        
        # SSLä¸Šä¸‹æ–‡ç¼“å­˜
        ssl_context_cache {
            enable                  on;
            cache_size             50;
            cache_ttl              3600;   # 1å°æ—¶
        }
        
        # è®¤è¯ç»“æœç¼“å­˜
        auth_result_cache {
            enable                  on;
            cache_size             1000;
            cache_ttl              300;    # 5åˆ†é’Ÿ
        }
    }
}

# ==================================================
# å¼€å‘å’Œè°ƒè¯•é…ç½® (Development & Debug)
# ==================================================

debug_config {
    debug_mode                  off;
    verbose_logging             on;
    trace_rpc_calls            on;
    dump_messages              off;
    
    # ğŸ” æ±¡æŸ“æºè¿½è¸ªè°ƒè¯•
    taint_tracing {
        enable_tracing             on;
        trace_propagation          on;
        dump_taint_info           off;
        max_trace_depth           10;
    }
    
    # æµ‹è¯•æ¨¡å¼è®¾ç½®
    test_mode {
        enable                     off;
        mock_ssl_operations        off;
        simulate_network_delays    off;
        inject_random_failures     off;
    }
}

# ==================================================
# ç¤ºä¾‹é…ç½®éªŒè¯
# ==================================================

# è¿™ä¸ªé…ç½®æ–‡ä»¶å®šä¹‰äº†ï¼š
# 1. 5ä¸ªå®‰å…¨åŸŸï¼Œæ¯ä¸ªåŸŸæœ‰æ˜ç¡®çš„èŒè´£å’Œå®‰å…¨çº§åˆ«
# 2. è¯¦ç»†çš„è·¨åŸŸè®¿é—®æ§åˆ¶è§„åˆ™ï¼Œç‰¹åˆ«ä¿æŠ¤SSLç§é’¥è·¯å¾„ä¼ é€’
# 3. å®Œæ•´çš„å®‰å…¨ç­–ç•¥ï¼ŒåŒ…æ‹¬è®¤è¯ã€æˆæƒã€å®¡è®¡
# 4. æ€§èƒ½ä¼˜åŒ–é…ç½®ï¼Œç¡®ä¿é«˜æ•ˆçš„RPCé€šä¿¡
# 5. å¼€å‘å’Œè°ƒè¯•æ”¯æŒï¼Œä¾¿äºå¼€å‘å’Œæ•…éšœæ’é™¤

# ğŸ”‘ ç‰¹åˆ«æ³¨æ„ï¼šSSLç§é’¥è·¯å¾„è¢«æ ‡è®°ä¸ºCRITICALçº§åˆ«æ±¡æŸ“æºï¼Œ
# åªèƒ½åœ¨configurationåŸŸå’Œssl_certificateåŸŸä¹‹é—´ä¼ é€’ï¼Œ
# å¹¶ä¸”éœ€è¦æœ€é«˜çº§åˆ«çš„å®‰å…¨æ§åˆ¶å’Œå®¡è®¡ã€‚
